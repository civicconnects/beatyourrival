rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // DEVELOPMENT RULES - PERMISSIVE FOR TESTING
    // TODO: Tighten these before production launch
    
    // Users collection
    match /Users/{userId} {
      // Anyone can read user profiles (needed for search, leaderboard, battle opponent info)
      allow read: if true;
      
      // Authenticated users can create their own profile during signup
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Users can only update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Users can delete their own profile
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Battles collection
    match /Battles/{battleId} {
      // Any authenticated user can read battles (for battle history, active battles)
      allow read: if request.auth != null;
      
      // Any authenticated user can create battles
      allow create: if request.auth != null;
      
      // Only battle participants can update
      allow update: if request.auth != null && 
                      (request.auth.uid == resource.data.challengerUid || 
                       request.auth.uid == resource.data.opponentUid);
      
      // Only battle participants can delete
      allow delete: if request.auth != null && 
                      (request.auth.uid == resource.data.challengerUid || 
                       request.auth.uid == resource.data.opponentUid);
      
      // Moves subcollection (battle rounds)
      match /Moves/{moveId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }
    
    // Activities collection (activity feed)
    match /Activities/{activityId} {
      // Any authenticated user can read the activity feed
      allow read: if request.auth != null;
      
      // Any authenticated user can create activity entries
      allow create: if request.auth != null;
      
      // Only the creator can update their activities
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Only the creator can delete their activities
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Friends collection
    match /Friends/{friendId} {
      // Any authenticated user can read friends data
      allow read: if request.auth != null;
      
      // Any authenticated user can create friend requests
      allow create: if request.auth != null;
      
      // Users involved in the friendship can update
      allow update: if request.auth != null;
      
      // Users involved in the friendship can delete
      allow delete: if request.auth != null;
    }
    
    // Catch-all for any other collections (for development flexibility)
    match /{document=**} {
      // Allow authenticated users to read/write during development
      // TODO: Remove this before production and add specific rules for each collection
      allow read, write: if request.auth != null;
    }
  }
}
