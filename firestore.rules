rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // DEVELOPMENT RULES - PERMISSIVE FOR TESTING
    // TODO: Tighten these before production launch
    
    // Users collection
    match /Users/{userId} {
      // Anyone can read user profiles (needed for search, leaderboard, battle opponent info)
      allow read: if true;
      
      // Authenticated users can create their own profile during signup
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Users can only update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Users can delete their own profile
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Battles collection (lowercase 'battles' to match actual collection name)
    match /battles/{battleId} {
      // Any authenticated user can read battles (for battle history, active battles)
      allow read: if true;  // Allow even unauthenticated for spectators (we check in app)
      
      // Any authenticated user can create battles
      allow create: if request.auth != null;
      
      // Only battle participants can update
      allow update: if request.auth != null && 
                      (request.auth.uid == resource.data.challengerUid || 
                       request.auth.uid == resource.data.opponentUid);
      
      // Only battle participants can delete
      allow delete: if request.auth != null && 
                      (request.auth.uid == resource.data.challengerUid || 
                       request.auth.uid == resource.data.opponentUid);
      
      // Moves subcollection (battle rounds) - lowercase 'moves' to match actual collection
      match /moves/{moveId} {
        allow read: if true;  // Allow anyone to read moves (for spectators)
        allow write: if request.auth != null;
      }
    }
    
    // Activities collection (uppercase 'Activities' - old collection)
    match /Activities/{activityId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Activity collection (lowercase 'activity' - current collection)
    match /activity/{activityId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Friends collection
    match /Friends/{friendId} {
      // Any authenticated user can read friends data
      allow read: if request.auth != null;
      
      // Any authenticated user can create friend requests
      allow create: if request.auth != null;
      
      // Users involved in the friendship can update
      allow update: if request.auth != null;
      
      // Users involved in the friendship can delete
      allow delete: if request.auth != null;
    }
    
    // Catch-all for any other collections (for development flexibility)
    match /{document=**} {
      // Allow authenticated users to read/write during development
      // TODO: Remove this before production and add specific rules for each collection
      allow read, write: if request.auth != null;
    }
  }
}
